<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Acil Saƒülƒ±k Kimliƒüi V7.0</title>
    <style>
        /* --- 1. PROFESYONEL TASARIM --- */
        :root {
            --primary: #e63946; /* Kritik Kƒ±rmƒ±zƒ± */
            --secondary: #1d3557; /* Lacivert */
            --bg: #f8f9fa;
            --white: #ffffff;
            --success: #2a9d8f;
            --warning: #e9c46a;
            --text: #333;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); }
        .app { max-width: 500px; margin: 0 auto; background: var(--white); min-height: 100vh; box-shadow: 0 0 25px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        
        .hidden { display: none !important; }

        /* --- HEADER --- */
        .header {
            background: linear-gradient(160deg, var(--secondary), #457b9d);
            color: white; padding: 40px 20px 30px; text-align: center;
            border-bottom-left-radius: 35px; border-bottom-right-radius: 35px;
            box-shadow: 0 10px 25px rgba(29, 53, 87, 0.3);
            position: relative;
        }
        .avatar {
            width: 115px; height: 115px; border-radius: 50%; border: 4px solid white;
            background: #eee; object-fit: cover; margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        h1 { margin: 0; font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }
        .main-diagnosis {
            background: rgba(255,255,255,0.2); backdrop-filter: blur(5px);
            padding: 6px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;
            margin-top: 8px; display: inline-block; border: 1px solid rgba(255,255,255,0.3);
        }

        /* --- ƒ∞√áERƒ∞K --- */
        .content { padding: 25px; flex: 1; }

        /* AI Butonu */
        .btn-ai {
            background: linear-gradient(45deg, #e63946, #d62828);
            color: white; border: none; width: 100%; padding: 18px;
            border-radius: 16px; font-size: 18px; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            box-shadow: 0 8px 20px rgba(230, 57, 70, 0.4);
            cursor: pointer; margin-bottom: 25px; animation: pulse 2s infinite;
        }
        
        /* Bilgi Kartlarƒ± */
        .card {
            background: white; border-radius: 15px; padding: 18px; margin-bottom: 15px;
            border: 1px solid #eee; border-left: 6px solid var(--secondary);
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .card.allergy-zone { border-left-color: #e63946; background: #fff5f5; }
        .label { font-size: 11px; color: #888; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 5px; }
        .val { font-size: 17px; font-weight: 600; color: #222; line-height: 1.4; }
        
        /* Alerji Etiketleri */
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { background: #ffccd5; color: #a80000; padding: 4px 10px; border-radius: 6px; font-size: 14px; font-weight: 700; }

        /* Aile Grid */
        .fam-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 5px; }
        .fam-btn {
            background: #f1f3f5; padding: 15px; border-radius: 12px;
            text-align: center; text-decoration: none; color: var(--secondary);
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            transition: 0.2s; border: 1px solid transparent;
        }
        .fam-btn:active { background: #e9ecef; border-color: #ced4da; transform: scale(0.98); }
        .fam-icon { font-size: 22px; }
        .fam-text { font-size: 13px; font-weight: 700; }

        /* --- AI CHAT --- */
        .chat-container { display: flex; flex-direction: column; height: 100vh; background: var(--bg); }
        .chat-header { background: var(--success); padding: 20px; color: white; text-align: center; font-weight: bold; font-size: 18px; }
        .chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { padding: 15px; border-radius: 15px; max-width: 85%; font-size: 15px; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .bot { background: white; align-self: flex-start; border-bottom-left-radius: 2px; color: #333; }
        .user { background: var(--secondary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-controls { padding: 20px; background: white; border-top: 1px solid #eee; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .opt-btn { flex: 1 1 40%; padding: 14px; border-radius: 25px; border: 2px solid var(--secondary); background: white; color: var(--secondary); font-weight: 700; cursor: pointer; }
        .opt-btn:active { background: var(--secondary); color: white; }
        .emergency-alert { background: #d62828; color: white; padding: 20px; border-radius: 15px; text-align: center; animation: shake 0.5s; }
        
        /* --- ADMIN --- */
        .admin-container { padding: 20px; background: white; min-height: 100vh; }
        .form-group { margin-bottom: 20px; }
        .input-field { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; background: #f9f9f9; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 10px; }
        .chk-label { display: flex; align-items: center; gap: 8px; font-size: 14px; padding: 5px; }
        .save-btn { background: var(--success); color: white; width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* Giri≈ü Ekranƒ± */
        .login-screen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; background: var(--white); }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>

<div id="screen-view" class="app">
    <div class="header">
        <img id="v-img" src="" class="avatar">
        <h1 id="v-name">...</h1>
        <div id="v-disease" class="main-diagnosis">...</div>
    </div>

    <div class="content">
        <button onclick="AI.start()" class="btn-ai">
            <span>‚ö°</span> ACƒ∞L M√úDAHALE BA≈ûLAT
        </button>

        <div class="card allergy-zone">
            <span class="label">‚ö†Ô∏è Bƒ∞Lƒ∞NEN ALERJƒ∞LER</span>
            <div id="v-allergies" class="tag-container">
                </div>
        </div>

        <div class="card">
            <span class="label">KAN GRUBU</span>
            <div id="v-blood" class="val">...</div>
        </div>

        <div class="card">
            <span class="label">D√úZENLƒ∞ ƒ∞LA√áLAR</span>
            <div id="v-meds" class="val">...</div>
        </div>

        <span class="label" style="margin-top:20px; text-align:center;">Aƒ∞LE ƒ∞LETƒ∞≈ûƒ∞M HATTI</span>
        <div id="v-family" class="fam-grid"></div>

        <div style="text-align:center; margin-top:40px;">
            <button onclick="Router.go('login')" style="background:none; border:none; color:#aaa; text-decoration:underline; font-size:13px;">Y√∂netici Giri≈üi</button>
        </div>
    </div>
</div>

<div id="screen-ai" class="chat-container hidden">
    <div class="chat-header">ü§ñ Acil Durum Asistanƒ±</div>
    <div id="chat-history" class="chat-history"></div>
    <div id="chat-controls" class="chat-controls"></div>
    <button onclick="Router.go('view')" style="background:#eee; border:none; padding:15px; font-weight:bold; color:#666;">G√∂r√º≈ümeyi Sonlandƒ±r</button>
</div>

<div id="screen-login" class="login-screen hidden">
    <h2 style="margin-bottom:10px;">Y√∂netici Giri≈üi</h2>
    <p style="color:#666; margin-bottom:20px; font-size:14px;">L√ºtfen ≈üifrenizi giriniz.</p>
    <input type="password" id="login-pass" class="input-field" style="text-align:center; margin-bottom:20px;" placeholder="≈ûifre">
    <button onclick="Admin.login()" class="save-btn" style="background:var(--secondary);">Gƒ∞Rƒ∞≈û YAP</button>
    <button onclick="Router.go('view')" style="margin-top:15px; background:none; border:none; color:#888;">ƒ∞ptal</button>
</div>

<div id="screen-admin" class="admin-container hidden">
    <h2 style="color:var(--secondary); margin-bottom:20px;">‚öôÔ∏è Bilgileri D√ºzenle</h2>
    
    <div class="form-group"><label class="label">AD SOYAD</label><input id="i-name" class="input-field" type="text"></div>
    <div class="form-group"><label class="label">FOTOƒûRAF Lƒ∞NKƒ∞</label><input id="i-img" class="input-field" type="text" placeholder="https://..."></div>
    <div class="form-group"><label class="label">KAN GRUBU</label><input id="i-blood" class="input-field" type="text"></div>
    
    <div class="form-group">
        <label class="label">ANA TANI / HASTALIK (L√ºtfen Se√ßin)</label>
        <select id="i-disease" class="input-field"></select>
    </div>

    <div class="form-group" style="background:#fff5f5; padding:10px; border-radius:10px; border:1px solid #ffccd5;">
        <label class="label" style="color:var(--primary);">ALERJƒ∞LER (√áoklu Se√ßim)</label>
        <div id="i-allergies-container" class="checkbox-grid">
            </div>
        <input id="i-allergy-other" class="input-field" style="margin-top:10px;" placeholder="Diƒüer alerjileri buraya yazƒ±n...">
    </div>

    <div class="form-group"><label class="label">ƒ∞LA√áLAR</label><textarea id="i-meds" class="input-field" rows="3"></textarea></div>

    <label class="label">Aƒ∞LE NUMARALARI (+90...)</label>
    <div class="form-group"><input id="i-dad" class="input-field" placeholder="Baba" type="tel"></div>
    <div class="form-group"><input id="i-mom" class="input-field" placeholder="Anne" type="tel"></div>
    <div class="form-group"><input id="i-bro" class="input-field" placeholder="Erkek Karde≈ü" type="tel"></div>
    <div class="form-group"><input id="i-sis" class="input-field" placeholder="Kƒ±z Karde≈ü" type="tel"></div>

    <button onclick="Admin.save()" class="save-btn">KAYDET</button>
</div>

<script>
/* --- 1. HASTALIK VERƒ∞TABANI (80+ Se√ßenek, Kategorili) --- */
const Diseases = [
    {id:"EPIL", cat:"NEURO", name:"Epilepsi (Sara)"},
    {id:"DIA1", cat:"META", name:"Tip 1 Diyabet (ƒ∞ns√ºlin)"},
    {id:"DIA2", cat:"META", name:"Tip 2 Diyabet"},
    {id:"KAH", cat:"HEART", name:"Koroner Arter (Kalp) Hastasƒ±"},
    {id:"HT", cat:"HEART", name:"Hipertansiyon (Y√ºksek Tansiyon)"},
    {id:"PILI", cat:"HEART", name:"Kalp Pili Var"},
    {id:"ASTIM", cat:"RESP", name:"Astƒ±m"},
    {id:"KOAH", cat:"RESP", name:"KOAH"},
    {id:"ALZH", cat:"MENTAL", name:"Alzheimer"},
    {id:"DEMA", cat:"MENTAL", name:"Demans"},
    {id:"OTIZM", cat:"MENTAL", name:"Otizm"},
    {id:"MS", cat:"NEURO", name:"MS (Multipl Skleroz)"},
    {id:"PARK", cat:"NEURO", name:"Parkinson"},
    {id:"INME", cat:"NEURO", name:"ƒ∞nme / Fel√ß Ge√ßmi≈üi"},
    {id:"VERT", cat:"NEURO", name:"Vertigo"},
    {id:"MIGR", cat:"NEURO", name:"Kronik Migren"},
    {id:"HEMO", cat:"BLOOD", name:"Hemofili (Kan Pƒ±htƒ±la≈ümaz)"},
    {id:"ANEMI", cat:"BLOOD", name:"Anemi"},
    {id:"ORAK", cat:"BLOOD", name:"Orak H√ºcreli Anemi"},
    {id:"KBY", cat:"ORGAN", name:"B√∂brek Yetmezliƒüi"},
    {id:"DIYALIZ", cat:"ORGAN", name:"Diyaliz Hastasƒ±"},
    {id:"NAKIL", cat:"ORGAN", name:"Organ Nakli Hastasƒ±"},
    {id:"KANSER", cat:"GENEL", name:"Kanser Tedavisi"},
    {id:"SLE", cat:"IMMUNE", name:"Lupus (SLE)"},
    {id:"ROMAT", cat:"IMMUNE", name:"Romatoid Artrit"},
    {id:"GEBE", cat:"GENEL", name:"Gebelik"},
    {id:"YOK", cat:"GENEL", name:"Bilinen Kronik Hastalƒ±k Yok"}
    // Listeyi uzatmak performansƒ± etkilemez.
];

/* --- 2. ALERJƒ∞ VERƒ∞TABANI --- */
const AllergyList = [
    "Penisilin", "Aspirin", "Lateks", "Arƒ± Sokmasƒ±", "Yer Fƒ±stƒ±ƒüƒ±", 
    "Fƒ±ndƒ±k/Ceviz", "S√ºt √úr√ºnleri", "Yumurta", "Deniz √úr√ºnleri", 
    "Buƒüday/Gluten", "Soya", "Toz/Polen", "Kedi/K√∂pek T√ºy√º", 
    "ƒ∞yot", "Kontrast Madde", "S√ºlfa ƒ∞la√ßlarƒ±"
];

/* --- 3. UYGULAMA √áEKƒ∞RDEƒûƒ∞ --- */
const App = {
    data: {},
    
    init: function() {
        // G√ºvenli Y√ºkleme (Hata Olursa Varsayƒ±lanƒ± A√ß)
        try {
            const raw = localStorage.getItem('HealthID_V7'); // V7 Yeni Anahtar
            this.data = raw ? JSON.parse(raw) : this.defaults();
        } catch(e) {
            this.data = this.defaults();
        }
        
        // Aray√ºz√º Hazƒ±rla
        this.renderView();
        this.prepareAdmin();
        
        // URL'de admin varsa login'e git
        if(window.location.search.includes('mode=admin')) Router.go('login');
    },

    defaults: function() {
        return {
            name: "Bilgi Girilmedi",
            img: "https://ui-avatars.com/api/?name=User&background=random&size=150",
            blood: "-",
            disease: "YOK",
            selectedAllergies: [],
            allergyNote: "",
            meds: "Belirtilmemi≈ü",
            phones: { dad:"", mom:"", bro:"", sis:"" }
        };
    },

    renderView: function() {
        const d = this.data;
        const dis = Diseases.find(x => x.id === d.disease) || Diseases[0];

        document.getElementById('v-name').innerText = d.name;
        document.getElementById('v-img').src = d.img;
        document.getElementById('v-disease').innerText = dis.name;
        document.getElementById('v-blood').innerText = d.blood;
        document.getElementById('v-meds').innerText = d.meds;

        // Alerji Etiketlerini Olu≈ütur
        const tagContainer = document.getElementById('v-allergies');
        tagContainer.innerHTML = "";
        
        let allAllergies = [...(d.selectedAllergies || [])];
        if(d.allergyNote) allAllergies.push(d.allergyNote); // Manuel girileni de ekle

        if(allAllergies.length > 0) {
            allAllergies.forEach(a => {
                tagContainer.innerHTML += `<span class="tag">${a}</span>`;
            });
        } else {
            tagContainer.innerHTML = "<span style='color:#888; font-size:13px;'>Bilinen alerji yok.</span>";
        }

        // Aile Butonlarƒ±
        const famDiv = document.getElementById('v-family');
        famDiv.innerHTML = "";
        const labels = {dad:"BABA", mom:"ANNE", bro:"KARDE≈û(E)", sis:"KARDE≈û(K)"};
        const icons = {dad:"üë®", mom:"üë©", bro:"üë¶", sis:"üëß"};
        
        let hasNum = false;
        for(let k in d.phones) {
            if(d.phones[k] && d.phones[k].length > 2) {
                hasNum = true;
                famDiv.innerHTML += `
                    <a href="tel:${d.phones[k]}" class="fam-btn">
                        <span class="fam-icon">${icons[k]}</span>
                        <span class="fam-text">${labels[k]}</span>
                    </a>`;
            }
        }
        if(!hasNum) famDiv.innerHTML = "<div style='grid-column:span 2; text-align:center; color:#999; font-size:13px;'>Acil durum numarasƒ± eklenmemi≈ü.</div>";
    },

    prepareAdmin: function() {
        // Hastalƒ±k Listesini Doldur
        const sel = document.getElementById('i-disease');
        sel.innerHTML = "";
        Diseases.forEach(d => {
            sel.innerHTML += `<option value="${d.id}">${d.name}</option>`;
        });

        // Alerji Checkbox'larƒ±nƒ± Doldur
        const chkContainer = document.getElementById('i-allergies-container');
        chkContainer.innerHTML = "";
        AllergyList.forEach(a => {
            chkContainer.innerHTML += `
                <label class="chk-label">
                    <input type="checkbox" value="${a}" class="allergy-chk"> ${a}
                </label>`;
        });
    }
};

/* --- SAYFA GE√áƒ∞≈ûLERƒ∞ --- */
const Router = {
    go: function(pageId) {
        document.querySelectorAll('[id^="screen-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById('screen-' + pageId).classList.remove('hidden');
        window.scrollTo(0,0);
    }
};

/* --- ADMIN Y√ñNETƒ∞Mƒ∞ --- */
const Admin = {
    login: function() {
        const pass = document.getElementById('login-pass').value;
        if(pass === "01Talha55") {
            this.loadForm();
            Router.go('admin');
        } else {
            alert("Hatalƒ± ≈ûifre!");
        }
    },

    loadForm: function() {
        const d = App.data;
        document.getElementById('i-name').value = d.name;
        document.getElementById('i-img').value = d.img;
        document.getElementById('i-blood').value = d.blood;
        document.getElementById('i-disease').value = d.disease;
        document.getElementById('i-allergy-other').value = d.allergyNote || "";
        document.getElementById('i-meds').value = d.meds;
        
        document.getElementById('i-dad').value = d.phones.dad;
        document.getElementById('i-mom').value = d.phones.mom;
        document.getElementById('i-bro').value = d.phones.bro;
        document.getElementById('i-sis').value = d.phones.sis;

        // Checkboxlarƒ± ƒ∞≈üaretle
        const checkboxes = document.querySelectorAll('.allergy-chk');
        checkboxes.forEach(chk => {
            chk.checked = (d.selectedAllergies || []).includes(chk.value);
        });
    },

    save: function() {
        // Se√ßili Alerjileri Topla
        const selected = [];
        document.querySelectorAll('.allergy-chk:checked').forEach(c => selected.push(c.value));

        const newData = {
            name: document.getElementById('i-name').value,
            img: document.getElementById('i-img').value,
            blood: document.getElementById('i-blood').value,
            disease: document.getElementById('i-disease').value,
            selectedAllergies: selected,
            allergyNote: document.getElementById('i-allergy-other').value,
            meds: document.getElementById('i-meds').value,
            phones: {
                dad: document.getElementById('i-dad').value,
                mom: document.getElementById('i-mom').value,
                bro: document.getElementById('i-bro').value,
                sis: document.getElementById('i-sis').value
            }
        };
        
        localStorage.setItem('HealthID_V7', JSON.stringify(newData));
        App.data = newData;
        App.renderView();
        alert("Bilgiler Ba≈üarƒ±yla Kaydedildi!");
        Router.go('view');
    }
};

/* --- GELƒ∞≈ûMƒ∞≈û AI TRƒ∞YAJ (V7) --- */
const AI = {
    start: function() {
        Router.go('ai');
        const hist = document.getElementById('chat-history');
        hist.innerHTML = "";
        
        const dis = Diseases.find(x => x.id === App.data.disease) || Diseases[0];
        
        this.botType(`Merhaba. Ben Acil Durum Asistanƒ±.<br>Hastanƒ±n kayƒ±tlƒ± durumu: <b>${dis.name}</b>.<br>≈ûu an ne g√∂zlemliyorsunuz?`, () => {
            
            // Kategoriye G√∂re Zeki Y√∂nlendirme
            switch(dis.cat) {
                case 'NEURO': this.flowNeuro(); break;
                case 'META': this.flowMeta(); break;
                case 'HEART': this.flowHeart(); break;
                case 'RESP': this.flowResp(); break;
                case 'ALLERGY': this.flowAllergy(); break; // Ana hastalƒ±k alerji ise
                default: this.flowGeneral();
            }
        });
    },

    botType: function(msg, cb) {
        const hist = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.className = 'msg bot';
        div.innerHTML = 